<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MuseAgent</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="icon" href="/assets/ma-logo.png" />
    <link rel="manifest" href="./manifest.webmanifest" />
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <!-- Icons -->
    <div style="position:absolute; width:0; height:0; overflow:hidden">
      <?xml version="1.0" encoding="UTF-8"?>
    </div>
    <object type="image/svg+xml" data="./icons.svg" style="position:absolute; width:0; height:0; overflow:hidden"></object>
    <!-- Splash overlay -->
    <div id="splash" role="status" aria-live="polite">
      <div class="splash-content">
        <img id="splash-logo" class="splash-logo" src="/assets/ma-logo.png" alt="MuseAgent logo" />
        <div class="splash-subtitle muted">Music Intelligence — analyze • tag • recommend • report</div>
      </div>
    </div>

    <!-- App chrome -->
    <header class="app-header">
      <div class="brand">
        <img class="brand-logo" src="/assets/ma-logo.png" alt="MuseAgent" />
      </div>
      <nav class="app-nav" role="tablist" aria-label="Primary">
        <a href="#analyze" id="tab-analyze" class="tab" role="tab" aria-selected="true" aria-controls="panel-analyze">Analyze</a>
        <a href="#explore" id="tab-explore" class="tab" role="tab" aria-selected="false" aria-controls="panel-explore">Explore</a>
        <a href="#generate" id="tab-generate" class="tab" role="tab" aria-selected="false" aria-controls="panel-generate">Generate</a>
        <a href="#insights" id="tab-insights" class="tab" role="tab" aria-selected="false" aria-controls="panel-insights">Insights</a>
      </nav>
      <div class="header-actions">
        <label class="toggle">
          <input id="sound-toggle" type="checkbox" />
          <span class="slider"></span>
          <span id="label-sound" class="label">Mute</span>
        </label>
        <label class="toggle">
          <input id="offline-toggle" type="checkbox" checked />
          <span class="slider"></span>
          <span id="label-offline" class="label">Online</span>
        </label>
        
        
        <div class="header-status" aria-label="Backend status" title="API status" style="margin-left:1rem;display:flex;align-items:center;gap:.6rem">
          <span class="status-item"><span id="dot-health" class="status-dot"></span><span class="status-label">API</span></span>
          <span class="status-item"><span id="dot-ready" class="status-dot"></span><span class="status-label">Index</span></span>
          <span class="status-metrics" style="display:flex;align-items:center;gap:.25rem">
            <canvas id="metrics-spark" width="120" height="24" aria-label="Latency"></canvas>
            <span id="ntotal" class="muted"></span>
          </span>
        </div>
      </div>
    </header>

    <main>
      <div id="panel-analyze" class="panel active" role="tabpanel" aria-labelledby="tab-analyze">
        <div class="analyze-split">
          <section class="card analyze-left">
            <h2 style="margin-top:0">Analyze Tracks</h2>
            <form id="upload-form" class="row">
              <input id="file-input" type="file" multiple accept="audio/*,video/*,.mp3,.wav,.flac,.mp4,.m4a" />
              <label class="toggle" style="margin-left:.5rem">
                <input id="enrich-toggle" type="checkbox" />
                <span class="slider"></span>
                <span id="label-enrich" class="label">Enrich</span>
              </label>
              <label class="toggle" style="margin-left:.5rem">
                <input id="generate-toggle" type="checkbox" />
                <span class="slider"></span>
                <span id="label-generate" class="label">Generate</span>
              </label>
              <button id="analyze-btn" type="submit">Analyze</button>
            </form>
            <div id="dropzone" class="dropzone" style="margin-top:.75rem">Drop audio/video files here to analyze</div>
            <div id="results" style="margin-top:1rem"></div>
            <div id="analyze-widgets" class="charts" style="margin-top:1rem; display:none">
              <canvas id="analyze-radar" width="300" height="220"></canvas>
              <canvas id="analyze-chroma" width="300" height="220"></canvas>
            </div>
            <div class="card" style="margin-top:1rem">
              <h2 style="margin:0 0 .5rem 0">Tap Tempo & Metronome</h2>
              <div class="row" style="margin-bottom:.5rem">
                <button id="tap-btn">Tap</button>
                <div class="muted">Current: <span id="tap-bpm">—</span> bpm</div>
                <label class="toggle"><input id="metro-toggle" type="checkbox"/><span class="slider"></span><span class="label">Metronome</span></label>
              </div>
              <div class="muted" id="tap-help">Tap at least 4 times to estimate BPM; toggle metronome to hear clicks.</div>
            </div>

            <div class="card" style="margin-top:1rem">
              <h2 style="margin:0 0 .5rem 0">Key Trainer</h2>
              <div id="key-trainer" class="row" style="flex-wrap:wrap"></div>
            </div>
            
            <div class="card" style="margin-top:1rem">
              <h2 style="margin:0 0 .5rem 0">AI Agents</h2>
              <div class="controls" style="margin-bottom:.5rem">
                <button id="agent-dance">Find danceable set</button>
                <button id="agent-ambient">Compile moody ambient</button>
                <button id="agent-summarize">Summarize library</button>
                <button id="agent-autotag">Auto‑tag selected</button>
              </div>
              <div id="agent-output" class="muted"></div>
            </div>
          </section>
          <section class="card analyze-right">
            <h2 style="margin:0 0 .5rem 0">Ask MuseAgent</h2>
            <div id="analyze-chat-log" class="chat-log" style="height:50vh"></div>
            <form id="analyze-chat-form" class="row" autocomplete="off" style="margin-top:.5rem">
              <input id="analyze-chat-text" type="text" placeholder="Ask Anything" style="flex:1"/>
              <button id="analyze-chat-send" type="submit" title="Send">↑</button>
            </form>
          </section>
        </div>
      </div>
      <div id="panel-generate" class="panel" role="tabpanel" aria-labelledby="tab-generate">
        <section class="card">
          <h2 style="margin:0 0 .5rem 0">Generate Music</h2>
          <form id="gen-form" class="row" style="gap:1rem; align-items:flex-end">
            <div class="row" style="gap:.5rem; flex-wrap:wrap">
              <select id="gen-genre"><option value="pop">Pop</option><option value="hiphop">Hip‑Hop</option><option value="edm">EDM</option><option value="rnb">R&B</option><option value="rock">Rock</option><option value="ambient">Ambient</option><option value="classical">Classical</option></select>
              <select id="gen-mood"><option value="happy">Happy</option><option value="energetic">Energetic</option><option value="chill">Chill</option><option value="dark">Dark</option><option value="melancholic">Melancholic</option></select>
              <select id="gen-key"><option>C</option><option>G</option><option>D</option><option>A</option><option>E</option><option>F</option><option>Am</option><option>Em</option><option>Dm</option><option>Gm</option></select>
              <label class="toggle"><input id="gen-autochords" type="checkbox" checked/><span class="slider"></span><span class="label">Auto‑chords</span></label>
              <label style="display:flex;align-items:center;gap:.4rem">BPM <input id="gen-bpm" type="number" value="110" min="60" max="180" style="width:80px"/></label>
              <label style="display:flex;align-items:center;gap:.4rem">Duration <input id="gen-duration" type="number" value="30" min="5" max="180" style="width:80px"/>s</label>
              <label style="display:flex;align-items:center;gap:.4rem">Creativity <input id="gen-creativity" type="range" min="0" max="1" step="0.05" value="0.5"/></label>
              <label style="display:flex;align-items:center;gap:.4rem">Seed <input id="gen-seed" type="number" value="0" min="0" max="999999" style="width:100px"/></label>
            </div>
            <div class="card" style="width:100%">
              <div class="muted" style="margin-bottom:.25rem">Examples: "drum and bass, 170 bpm, dark, influenced by Noisia" • "lyrics about summer nights with hopeful tone" • "ambient piano in Dm, slow 80 bpm" • "edm, catchy hook, Daft Punk vibes"</div>
              <label for="gen-describe" class="muted" style="font-weight:600">Describe</label>
              <textarea id="gen-describe" rows="3" placeholder="Describe what to create — genre, influences, mood, tempo, instruments, structure..."></textarea>
            </div>
            <div class="row" style="gap:.5rem; width:100%">
              <select id="gen-language"><option value="en">English</option><option value="es">Spanish</option><option value="fr">French</option><option value="ar">Arabic</option></select>
              <select id="gen-rhyme"><option value="AABB">AABB (Couplets)</option><option value="ABAB">ABAB (Alternating)</option><option value="free">Free (No scheme)</option></select>
              <select id="gen-vocals" title="Vocals"><option value="vocal">Vocals</option><option value="instrumental">Instrumental</option></select>
              <select id="gen-engine" title="Engine">
                <option value="melody">Hook‑forward (catchy, structured)</option>
                <option value="verse-chorus">Verse/Chorus (song form)</option>
                <option value="loop">Loop‑based (groove‑driven)</option>
                <option value="texture">Atmospheric (evolving, ambient)</option>
              </select>
              <button id="gen-randomize" type="button">Randomize</button>
              <button id="gen-submit" type="submit">Generate</button>
            </div>
            <div class="card" style="width:100%">
              <label for="gen-lyrics-prompt" class="muted" style="font-weight:600">Lyrics prompt</label>
              <textarea id="gen-lyrics-prompt" rows="5" placeholder="Write or paste lyrics here (or a brief theme)"></textarea>
            </div>
          </form>
          <div id="gen-results" style="margin-top:1rem"></div>
        </section>
      </div>
      <div id="panel-insights" class="panel" role="tabpanel" aria-labelledby="tab-insights">
        <section class="card">
          <h2 style="margin:0 0 .5rem 0">Insights</h2>
          <div class="insights-split">
            <aside class="insights-sidebar">
              <div id="insights-list" class="list"></div>
            </aside>
            <section class="insights-detail">
              <div id="insight-detail"></div>
            </section>
          </div>
        </section>
      </div>
      <div id="panel-explore" class="panel" role="tabpanel" aria-labelledby="tab-explore">
        <section class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem">
            <h2 style="margin:0"></h2>
            <div class="row">
              <select id="filter-key"><option value="">All Keys</option><option>C</option><option>G</option><option>D</option><option>A</option><option>E</option><option>F</option><option>Am</option><option>Em</option><option>Dm</option><option>Gm</option></select>
              <select id="filter-mood"><option value="">All Moods</option><option>chill</option><option>energetic</option><option>happy</option><option>sad</option><option>dark</option></select>
              <label class="toggle"><input id="filter-bpm-enabled" type="checkbox"/><span class="slider"></span><span class="label">BPM</span></label>
              <input id="filter-bpm-min" type="number" placeholder="Min" style="width:70px"/>
              <input id="filter-bpm-max" type="number" placeholder="Max" style="width:70px"/>
              <button id="apply-filters">Apply</button>
              <button id="reload-lib" style="border-color:var(--ma-muted);color:var(--ma-muted)">Reload</button>
              <input id="search" type="search" placeholder="Search…" style="width:160px"/>
              <button id="select-toggle" title="Toggle selection mode">Select</button>
              <button id="tag-selected-btn" title="Tag selected tracks">Tag Selected</button>
              <button id="compare-btn" title="Compare two selected (A/B)">Compare A/B</button>
              <button id="smart-playlist-btn" title="Generate Smart Playlist">Smart Playlist</button>
              <button id="prompt-playlist-btn" title="Build playlist from prompt">Prompt Playlist</button>
              <button id="map-toggle-btn" title="Show similarity map">Map</button>
              <button id="shortcuts-btn" title="Keyboard Shortcuts">Shortcuts</button>
            </div>
          </div>
          <div id="grid" class="grid" style="margin-top:1rem"></div>
          <div id="pager" class="row" style="margin-top:.5rem"></div>
          <section id="map-section" class="card" style="margin-top:1rem; display:none">
            <h3 style="margin:0 0 .5rem 0">Similarity Map</h3>
            <canvas id="map-canvas" width="900" height="420"></canvas>
          </section>
        </section>
      </div>
      
    </main>

    <!-- Detail modal -->
    <div id="detail" class="detail">
      <div class="detail-inner">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
          <h3 id="detail-title" style="margin:0"></h3>
          <button id="detail-close">Close</button>
        </div>
        <div id="detail-meta" class="muted" style="margin-bottom:.75rem"></div>
        <div class="charts">
          <canvas id="chart-radar" width="420" height="320"></canvas>
          <canvas id="chart-chroma" width="420" height="320"></canvas>
        </div>
      </div>
    </div>

    <!-- Toast container -->
    <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <!-- Chat assistant -->
    <div id="chat" class="chat">
      <div class="chat-inner">
        <div class="chat-header">
          <div style="display:flex;align-items:center;gap:.5rem"><img src="/assets/ma-logo.png" alt="" style="height:24px;width:auto"/> MuseAgent Assistant</div>
          <button id="chat-close">Close</button>
        </div>
        <div id="chat-log" class="chat-log" aria-live="polite"></div>
        <form id="chat-form" class="chat-input" autocomplete="off">
          <input id="chat-text" type="text" placeholder="Ask about tempo, key, mood, or recommendations..." />
          <button type="submit">Send</button>
        </form>
      </div>
    </div>

    <!-- Shortcuts overlay -->
    <div id="shortcuts" class="overlay">
      <div class="overlay-inner">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:.5rem">
          <h3 style="margin:0">Keyboard Shortcuts</h3>
          <button id="shortcuts-close">Close</button>
        </div>
        <ul class="muted" style="line-height:1.6">
          <li>Ctrl + Arrow Left/Right: Switch tabs</li>
          <li>S: Toggle selection mode</li>
          <li>A: Select all visible</li>
          <li>T: Tag selected</li>
          <li>P: Generate Smart Playlist</li>
          <li>/: Open Chat</li>
          <li>Esc: Close dialogs</li>
        </ul>
      </div>
    </div>

    

    

    <script src="./app.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('./sw.js').catch(() => {});
      }
      // Default to offline mode on first load
      try {
        const stored = localStorage.getItem('ma-offline');
        const offline = stored === null ? '1' : stored;
        const toggle = document.getElementById('offline-toggle');
        if (toggle) toggle.checked = offline === '1';
        toggle?.addEventListener('change', () => localStorage.setItem('ma-offline', toggle.checked ? '1' : '0'));
      } catch (e) {}
    </script>
  </body>
  </html>


